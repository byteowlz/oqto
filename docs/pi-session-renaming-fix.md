# Pi Session Renaming Fix

## Problem

1. **Message mixing between sessions**: Messages from different Pi sessions were appearing in the wrong sessions in Oqto frontend
2. **Auto-generated title parsing**: Pi extension auto-renames sessions to `<workdir>: <generated_title> [adj-noun-verb]`, but:
   - Frontend displayed the full title including workspace and ID
   - The `readable_id` field was missing from backend API
   - No unified parsing logic between frontend and backend

## Solution

### Backend Changes (`backend/crates/oqto/src/`)

1. **New parser module**: `pi/session_parser.rs`
   - Parses auto-generated title format: `<workdir>: <title> [readable_id]`
   - Extracts workspace, clean title, and readable ID components
   - Handles both auto-generated and plain title formats

2. **Updated `PiSessionFile` struct** (`main_chat/pi_service.rs`)
   - Added `readable_id: Option<String>` field
   - This matches frontend expectations

3. **Updated session listing** (`main_chat/pi_service.rs`)
   - `parse_session_file()` now parses titles and extracts `readable_id`
   - Returns clean display title (workspace and ID stripped)
   - Stores full auto-generated format in session file but returns cleaner version

### Frontend Changes (`frontend/`)

1. **Updated TypeScript type** (`lib/control-plane-client.ts`)
   - Added `readable_id?: string` to `PiSessionFile` type

2. **New session utility functions** (`lib/session-utils.ts`)
   - `ParsedPiTitle` interface: Parsed components of auto-generated title
   - `parseAutoGeneratedTitle()`: Extracts workspace, title, and readable_id
   - `getDisplayPiTitle()`: Returns clean title for display

3. **Updated session displays**:
   - `MainChatTimeline.tsx`: Uses parsed clean title and backend readable_id
   - `MainChatEntry.tsx`: Uses parsed clean title and backend readable_id
   - Both now correctly filter by workspace name, clean title, and readable_id

## Session Title Format

### Auto-generated (Pi extension):
```
<workdir>: <generated_title> [adj-noun-verb]
```

Examples:
- `frontend: Discuss the login flow [cold-lamp-verb]`
- `backend: Fix authentication bug [blue-frog-fix]`
- `docs: Update README [happy-camel-write]`

### Parsed components:
- **workspace**: `frontend`, `backend`, `docs`
- **title**: `Discuss the login flow`, `Fix authentication bug`, `Update README`
- **readable_id**: `cold-lamp-verb`, `blue-frog-fix`, `happy-camel-write`

## Frontend Display

After the fix, sessions display as:

```
Discuss the login flow [cold-lamp-verb]
Fix authentication bug [blue-frog-fix]
Update README [happy-camel-write]
```

The workspace prefix and ID brackets are still shown in tooltips for context.

## Benefits

1. **Consistent readable IDs**: The same `adj-noun-verb` ID is shown everywhere
2. **Cleaner UI**: Session titles no longer show workspace prefix
3. **Better search**: Can search by workspace name, clean title, or readable ID
4. **Backend authority**: Backend provides canonical readable_id, frontend uses it

## Testing

```bash
# Backend
cd backend && cargo check -p oqto

# Frontend
cd frontend && bun run build

# Test locally
bun run dev
```

## Migration

Existing sessions with auto-generated titles will be:
1. Parsed on next list/refresh
2. Displayed with clean title
3. Include correct readable_id in UI

New sessions from Pi extension will be automatically parsed.
