# Default compose file for x86_64 with Caddy reverse proxy
# Works with both Docker and Podman:
#   Docker (macOS dev):  docker compose up
#   Podman (Linux prod): podman-compose up
#
# Architecture:
#   - Caddy: Reverse proxy, single entry point for all containers
#   - EAVS: LLM proxy, manages virtual keys and usage tracking
#   - Backend: Orchestrates containers, creates EAVS keys per session
#   - Containers: Run opencode with EAVS virtual key for LLM access

networks:
  # Public network - Caddy connects here and exposes ports
  octo-public:
    driver: bridge
  # Internal network - containers communicate without host exposure
  octo-internal:
    driver: bridge
    internal: true

services:
  # EAVS - LLM proxy for virtual keys and usage tracking
  # All containers route LLM traffic through EAVS using virtual keys
  # Backend creates/revokes keys via admin API
  eavs:
    image: ghcr.io/eavs/eavs:latest  # TODO: Replace with actual image
    container_name: octo-eavs
    restart: unless-stopped
    ports:
      - "41800:3000"  # EAVS API (accessible from host and containers via host.docker.internal)
    environment:
      # Master key for admin operations (create/revoke virtual keys)
      - EAVS_MASTER_KEY=${EAVS_MASTER_KEY:-dev-master-key-change-in-production}
      # Upstream LLM provider keys
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      # Optional: Other providers
      # - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      # - AZURE_OPENAI_API_KEY=${AZURE_OPENAI_API_KEY}
    volumes:
      - eavs_data:/data
    networks:
      - octo-public
      - octo-internal
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Caddy reverse proxy - single entry point for all containers
  caddy:
    image: caddy:2-alpine
    container_name: octo-caddy
    restart: unless-stopped
    ports:
      - "41800:80"    # HTTP
      - "41801:443"   # HTTPS
      - "41802:2019"  # Admin API for dynamic route management
    volumes:
      - ./caddy/caddy.json:/etc/caddy/caddy.json:ro
      - caddy_data:/data
      - caddy_config:/config
    command: ["caddy", "run", "--config", "/etc/caddy/caddy.json"]
    networks:
      - octo-public
      - octo-internal
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3

  # Template container - use this as a reference for spawning new containers
  # In production, the Rust backend will spawn these dynamically
  octo-template:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: dev
        USER_UID: 1000
        USER_GID: 1000
    image: octo-dev:x86_64
    # Container is not started by default - it's a template
    profiles:
      - template
    networks:
      - octo-internal
    volumes:
      - ./workspace:/home/dev/workspace
    stdin_open: true
    tty: true

volumes:
  caddy_data:
  caddy_config:
  eavs_data:
