#!/usr/bin/env bash
# Octo First Boot Script
# Runs on first boot to complete setup
set -euo pipefail

MARKER_FILE="/var/lib/octo/.first-boot-complete"

# Skip if already run
if [[ -f "$MARKER_FILE" ]]; then
    exit 0
fi

# Colors
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[OCTO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OCTO]${NC} $*"; }

log_info "Running first boot setup..."

# Initialize Rust toolchain for octo user if needed
if command -v rustup &>/dev/null; then
    log_info "Setting up Rust toolchain..."
    rustup default stable 2>/dev/null || true
fi

# Install bun if not present
if ! command -v bun &>/dev/null; then
    log_info "Installing Bun..."
    curl -fsSL https://bun.sh/install | bash
fi

# Install opencode if not present
if ! command -v opencode &>/dev/null; then
    log_info "Installing OpenCode..."
    curl -fsSL https://opencode.ai/install | bash 2>/dev/null || true
fi

# Create marker file
mkdir -p /var/lib/octo
touch "$MARKER_FILE"

log_success "First boot setup complete"
