#!/usr/bin/env bash
# Octo Setup Script - Run after installation to disk
# This script configures Octo for first use
set -euo pipefail

OCTO_USER="${OCTO_USER:-octo}"
OCTO_CONFIG_DIR="/etc/octo"
OCTO_DATA_DIR="/var/lib/octo"
OCTO_BIN_DIR="/usr/local/bin"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

log_info() { echo -e "${BLUE}[INFO]${NC} $*"; }
log_success() { echo -e "${GREEN}[OK]${NC} $*"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

echo ""
echo "=========================================="
echo "  Octo AI Agent Platform Setup"
echo "=========================================="
echo ""

# Check if running as root
if [[ $EUID -ne 0 ]]; then
    log_error "This script must be run as root"
    exit 1
fi

# Create admin user account if none exists (besides root)
EXISTING_USERS=$(awk -F: '$3 >= 1000 && $3 < 2000 && $1 != "nobody" {print $1}' /etc/passwd)
if [[ -z "$EXISTING_USERS" ]]; then
    echo ""
    log_info "No admin user account found. Let's create one."
    echo ""
    
    # Get username
    while true; do
        read -rp "Enter admin username: " ADMIN_USER
        if [[ -z "$ADMIN_USER" ]]; then
            log_error "Username cannot be empty"
            continue
        fi
        if [[ ! "$ADMIN_USER" =~ ^[a-z_][a-z0-9_-]*$ ]]; then
            log_error "Invalid username. Use lowercase letters, numbers, underscore, hyphen."
            continue
        fi
        if [[ "$ADMIN_USER" == octo_* ]]; then
            log_error "Username cannot start with 'octo_' (reserved for managed users)"
            continue
        fi
        break
    done
    
    # Create the user
    log_info "Creating user: $ADMIN_USER"
    useradd -m -G wheel,octo -s /bin/bash "$ADMIN_USER"
    
    # Set password
    echo ""
    log_info "Set password for $ADMIN_USER:"
    while ! passwd "$ADMIN_USER"; do
        log_error "Password setting failed. Try again."
    done
    
    # Enable sudo for wheel group
    if [[ -f /etc/sudoers.d/wheel ]]; then
        log_info "Wheel group sudo already configured"
    else
        echo "%wheel ALL=(ALL:ALL) ALL" > /etc/sudoers.d/wheel
        chmod 440 /etc/sudoers.d/wheel
    fi
    
    log_success "Admin user '$ADMIN_USER' created with sudo access"
    
    # Offer to add SSH key
    echo ""
    read -rp "Add SSH public key for $ADMIN_USER? [y/N]: " ADD_SSH_KEY
    if [[ "$ADD_SSH_KEY" =~ ^[Yy] ]]; then
        ADMIN_HOME=$(eval echo "~$ADMIN_USER")
        mkdir -p "$ADMIN_HOME/.ssh"
        chmod 700 "$ADMIN_HOME/.ssh"
        
        echo "Paste your SSH public key (or leave empty to skip):"
        read -r SSH_KEY
        if [[ -n "$SSH_KEY" ]]; then
            echo "$SSH_KEY" >> "$ADMIN_HOME/.ssh/authorized_keys"
            chmod 600 "$ADMIN_HOME/.ssh/authorized_keys"
            chown -R "$ADMIN_USER:$ADMIN_USER" "$ADMIN_HOME/.ssh"
            log_success "SSH key added"
        else
            log_info "Skipped SSH key setup"
        fi
    fi
    echo ""
else
    log_info "Existing user accounts found: $EXISTING_USERS"
fi

# Set hostname if still default
CURRENT_HOSTNAME=$(hostname)
if [[ "$CURRENT_HOSTNAME" == "archiso" || "$CURRENT_HOSTNAME" == "localhost" ]]; then
    echo ""
    read -rp "Enter hostname for this server [octo-server]: " NEW_HOSTNAME
    NEW_HOSTNAME="${NEW_HOSTNAME:-octo-server}"
    
    if [[ "$NEW_HOSTNAME" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?$ ]]; then
        hostnamectl set-hostname "$NEW_HOSTNAME"
        log_success "Hostname set to: $NEW_HOSTNAME"
    else
        log_warn "Invalid hostname, keeping: $CURRENT_HOSTNAME"
    fi
    echo ""
fi

# Create octo system user
log_info "Creating octo system user..."
if ! id "$OCTO_USER" &>/dev/null; then
    useradd -r -s /usr/sbin/nologin -d "$OCTO_DATA_DIR" -m "$OCTO_USER"
    log_success "Created user: $OCTO_USER"
else
    log_info "User $OCTO_USER already exists"
fi

# Create octo group
if ! getent group octo &>/dev/null; then
    groupadd octo
    log_success "Created group: octo"
fi

# Create directories
log_info "Creating directories..."
mkdir -p "$OCTO_CONFIG_DIR" "$OCTO_DATA_DIR" /run/octo /run/octo/runner-sockets
chown -R "$OCTO_USER:$OCTO_USER" "$OCTO_DATA_DIR"
chown root:octo /run/octo /run/octo/runner-sockets
chmod 775 /run/octo /run/octo/runner-sockets
log_success "Directories created"

# Generate JWT secret if not exists
if [[ ! -f "$OCTO_CONFIG_DIR/jwt_secret" ]]; then
    log_info "Generating JWT secret..."
    openssl rand -base64 48 > "$OCTO_CONFIG_DIR/jwt_secret"
    chmod 600 "$OCTO_CONFIG_DIR/jwt_secret"
    chown "$OCTO_USER:$OCTO_USER" "$OCTO_CONFIG_DIR/jwt_secret"
    log_success "JWT secret generated"
fi

JWT_SECRET=$(cat "$OCTO_CONFIG_DIR/jwt_secret")

# Generate config if not exists
if [[ ! -f "$OCTO_CONFIG_DIR/config.toml" ]]; then
    log_info "Generating configuration..."
    cat > "$OCTO_CONFIG_DIR/config.toml" << EOF
# Octo Configuration
# Generated by octo-setup

[logging]
level = "info"

[server]
host = "0.0.0.0"
port = 8080

[auth]
dev_mode = false
jwt_secret = "$JWT_SECRET"
allowed_origins = []

[backend]
mode = "local"

[local]
enabled = true
opencode_binary = "opencode"
fileserver_binary = "octo-files"
ttyd_binary = "ttyd"
workspace_dir = "/home/{linux_username}/workspaces"
single_user = false

[local.linux_users]
enabled = true
prefix = "octo_"
uid_start = 2000
group = "octo"
# SECURITY: Shell must be /bin/bash to match sudoers regex pattern
shell = "/bin/bash"
use_sudo = true
create_home = true

[pi]
enabled = true
executable = "pi"
default_provider = "anthropic"
default_model = "claude-sonnet-4-20250514"
runtime_mode = "runner"

[sessions]
idle_timeout_minutes = 60
max_sessions_per_user = 5
EOF
    chown "$OCTO_USER:$OCTO_USER" "$OCTO_CONFIG_DIR/config.toml"
    chmod 640 "$OCTO_CONFIG_DIR/config.toml"
    log_success "Configuration generated at $OCTO_CONFIG_DIR/config.toml"
fi

# Setup sudoers for octo user management
# SECURITY: Uses regex patterns (requires sudo 1.9.10+) to prevent privilege escalation
log_info "Configuring sudoers with secure regex patterns..."

USER_PREFIX="octo_"
OCTO_GROUP="octo"
UID_START="2000"
UID_FIRST_DIGIT="2"

cat > /etc/sudoers.d/octo-multiuser << EOF
# Octo Multi-User Process Isolation - SECURE VERSION
# Generated by octo-setup on $(date)
#
# SECURITY: Uses regex patterns (^...\$) to prevent privilege escalation.
# - UIDs restricted to ${UID_FIRST_DIGIT}000-${UID_FIRST_DIGIT}999 range (avoids system/user UIDs)
# - Usernames must start with ${USER_PREFIX} prefix
# - Workspace chown restricted to ${USER_PREFIX}* home directories only
# Requires sudo 1.9.10+ for regex support.

# Group management - only create the ${OCTO_GROUP} group (safe - fixed value)
Cmnd_Alias OCTO_GROUPADD = /usr/sbin/groupadd ${OCTO_GROUP}

# User creation - RESTRICTED to safe UID range and ${USER_PREFIX} prefix
# Regex matches: -u NNNN -g ${OCTO_GROUP} -s /bin/bash -m/-M -c COMMENT USERNAME
# UID must be ${UID_FIRST_DIGIT}000-${UID_FIRST_DIGIT}999, username must start with ${USER_PREFIX}
Cmnd_Alias OCTO_USERADD = \\
    /usr/sbin/useradd ^-u [${UID_FIRST_DIGIT}][0-9][0-9][0-9] -g ${OCTO_GROUP} -s /bin/bash -m -c [^ ]+ ${USER_PREFIX}[a-z0-9_]+\$, \\
    /usr/sbin/useradd ^-u [${UID_FIRST_DIGIT}][0-9][0-9][0-9] -g ${OCTO_GROUP} -s /bin/bash -M -c [^ ]+ ${USER_PREFIX}[a-z0-9_]+\$

# User deletion - only ${USER_PREFIX} users, no home removal (-r flag not allowed)
Cmnd_Alias OCTO_USERDEL = /usr/sbin/userdel ^${USER_PREFIX}[a-z0-9_]+\$

# Directory creation for runner sockets - RESTRICTED path (no path traversal)
Cmnd_Alias OCTO_MKDIR = /usr/bin/mkdir ^-p /run/octo/runner-sockets/${USER_PREFIX}[a-z0-9_]+\$

# Runner socket ownership - RESTRICTED to exact paths
Cmnd_Alias OCTO_CHOWN_RUNNER = \\
    /usr/bin/chown ^${USER_PREFIX}[a-z0-9_]+:${OCTO_GROUP} /run/octo/runner-sockets/${USER_PREFIX}[a-z0-9_]+\$

# Workspace ownership - RESTRICTED to ${USER_PREFIX} user home directories ONLY
# SECURITY: Only allows chown on /home/${USER_PREFIX}*/... NOT on other users' homes
Cmnd_Alias OCTO_CHOWN_WORKSPACE = \\
    /usr/bin/chown ^-R ${USER_PREFIX}[a-z0-9_]+:${OCTO_GROUP} /home/${USER_PREFIX}[a-z0-9_]+(/[^.][^/]*)*/?\$

# Permissions for runner socket directories
Cmnd_Alias OCTO_CHMOD_RUNNER = /usr/bin/chmod ^2770 /run/octo/runner-sockets/${USER_PREFIX}[a-z0-9_]+\$

# systemd linger - only for ${USER_PREFIX} users
Cmnd_Alias OCTO_LINGER = /usr/bin/loginctl ^enable-linger ${USER_PREFIX}[a-z0-9_]+\$

# Start user systemd instance - RESTRICTED to ${USER_PREFIX} user UIDs
Cmnd_Alias OCTO_START_USER = /usr/bin/systemctl ^start user@[${UID_FIRST_DIGIT}][0-9][0-9][0-9].service\$

# User management - group and user creation
octo ALL=(root) NOPASSWD: OCTO_GROUPADD, OCTO_USERADD, OCTO_USERDEL

# systemd user management - enable/start octo-runner as ${USER_PREFIX}* users
Cmnd_Alias OCTO_RUNNER_SYSTEMCTL = \\
    /usr/bin/systemctl --user enable --now octo-runner, \\
    /usr/bin/systemctl --user start octo-runner, \\
    /usr/bin/systemctl --user enable octo-runner
octo ALL=(${USER_PREFIX}*) NOPASSWD: OCTO_RUNNER_SYSTEMCTL

# Runner socket directory setup and workspace ownership
octo ALL=(root) NOPASSWD: OCTO_MKDIR, OCTO_CHOWN_RUNNER, OCTO_CHOWN_WORKSPACE, OCTO_CHMOD_RUNNER

# User systemd management
octo ALL=(root) NOPASSWD: OCTO_START_USER, OCTO_LINGER
EOF

chmod 440 /etc/sudoers.d/octo-multiuser

# Validate the sudoers file
if visudo -c -f /etc/sudoers.d/octo-multiuser &>/dev/null; then
    log_success "Sudoers file validated: /etc/sudoers.d/octo-multiuser"
else
    log_error "Invalid sudoers file - removing it"
    rm -f /etc/sudoers.d/octo-multiuser
    log_warn "Sudoers not configured - may need sudo 1.9.10+ for regex support"
fi

# Enable systemd services
log_info "Enabling systemd services..."
systemctl daemon-reload

if [[ -f /etc/systemd/system/octo.service ]]; then
    systemctl enable octo.service
    log_success "Enabled octo.service"
fi

# Enable NetworkManager
systemctl enable NetworkManager
log_success "Enabled NetworkManager"

# Enable SSH (optional)
systemctl enable sshd
log_success "Enabled sshd"

# Create tmpfiles.d config for runtime directories
cat > /etc/tmpfiles.d/octo.conf << 'EOF'
# Octo runtime directories
d /run/octo 0755 root octo -
d /run/octo/runner-sockets 0775 root octo -
EOF
log_success "Created tmpfiles.d configuration"

# Install global npm tools
log_info "Installing global npm tools..."
if command -v npm &>/dev/null; then
    npm install -g agent-browser 2>/dev/null && log_success "Installed agent-browser" || log_warn "Failed to install agent-browser"
    # Install Chromium for agent-browser
    agent-browser install 2>/dev/null || true
fi

echo ""
log_success "Octo setup complete!"
echo ""
echo "Next steps:"
echo "  1. Build Octo binaries (if not pre-installed):"
echo "     cd /opt/octo && cargo build --release"
echo ""
echo "  2. Create admin user:"
echo "     octoctl user bootstrap -u admin -e admin@example.com"
echo ""
echo "  3. Start Octo:"
echo "     systemctl start octo"
echo ""
echo "  4. Access the web UI at http://localhost:8080"
echo ""
