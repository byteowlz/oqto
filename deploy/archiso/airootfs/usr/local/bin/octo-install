#!/usr/bin/env bash
# Octo Arch Linux Installer
# Full system installation from live ISO to bootable Octo server
#
# Inspired by omarchy's modular approach but simplified for headless server use
set -euo pipefail

#=============================================================================
# Configuration
#=============================================================================

# Default values
HOSTNAME="octo-server"
TIMEZONE="UTC"
LOCALE="en_US.UTF-8"
KEYMAP="us"
TARGET_DISK=""
BOOT_MODE=""
ADMIN_USER=""
ADMIN_PASSWORD=""
ROOT_PASSWORD=""
SSH_KEY=""

# Installation paths
INSTALL_LOG="/tmp/octo-install.log"

#=============================================================================
# Helpers (inspired by omarchy/install/helpers)
#=============================================================================

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
GRAY='\033[90m'
BOLD='\033[1m'
NC='\033[0m'

log_info() { echo -e "${BLUE}::${NC} $*"; }
log_success() { echo -e "${GREEN}::${NC} $*"; }
log_warn() { echo -e "${YELLOW}::${NC} $*"; }
log_error() { echo -e "${RED}:: ERROR:${NC} $*"; }
log_step() { echo -e "\n${CYAN}${BOLD}==> $*${NC}"; }
log_substep() { echo -e "  ${BLUE}->${NC} $*"; }

# Run command and log output
run_logged() {
    local cmd="$*"
    echo "[$(date '+%H:%M:%S')] Running: $cmd" >> "$INSTALL_LOG"
    if ! "$@" >> "$INSTALL_LOG" 2>&1; then
        log_error "Command failed: $cmd"
        log_error "Check $INSTALL_LOG for details"
        return 1
    fi
}

# Show spinner while command runs
run_with_spinner() {
    local msg="$1"
    shift
    local pid
    
    "$@" >> "$INSTALL_LOG" 2>&1 &
    pid=$!
    
    local spin='⠋⠙⠹⠸⠼⠴⠦⠧⠇⠏'
    local i=0
    while kill -0 $pid 2>/dev/null; do
        printf "\r  ${GRAY}${spin:i++%${#spin}:1}${NC} %s" "$msg"
        sleep 0.1
    done
    
    wait $pid
    local status=$?
    
    if [[ $status -eq 0 ]]; then
        printf "\r  ${GREEN}✓${NC} %s\n" "$msg"
    else
        printf "\r  ${RED}✗${NC} %s\n" "$msg"
        return $status
    fi
}

#=============================================================================
# Preflight Checks
#=============================================================================

show_banner() {
    clear
    echo -e "${CYAN}"
    cat << 'EOF'
   ____       _        
  / __ \  ___| |_ ___  
 | |  | |/ __| __/ _ \ 
 | |__| | (__| || (_) |
  \____/ \___|\__\___/ 
                       
  AI Agent Platform - Server Installer
EOF
    echo -e "${NC}"
    echo "This will install Arch Linux with Octo pre-configured."
    echo -e "${RED}WARNING: All data on the selected disk will be ERASED.${NC}"
    echo ""
}

check_requirements() {
    log_step "Checking requirements"
    
    # Must be root
    if [[ $EUID -ne 0 ]]; then
        log_error "This installer must be run as root"
        exit 1
    fi
    log_substep "Running as root"
    
    # Check internet
    if ! ping -c 1 -W 3 archlinux.org &>/dev/null; then
        log_error "No internet connection"
        echo ""
        echo "Configure networking first:"
        echo "  WiFi:  iwctl station wlan0 connect <SSID>"
        echo "  DHCP:  dhcpcd"
        exit 1
    fi
    log_substep "Internet connection OK"
    
    # Detect boot mode
    if [[ -d /sys/firmware/efi/efivars ]]; then
        BOOT_MODE="uefi"
        log_substep "Boot mode: UEFI"
    else
        BOOT_MODE="bios"
        log_substep "Boot mode: BIOS/Legacy"
    fi
    
    # Initialize log
    echo "=== Octo Installation Started: $(date) ===" > "$INSTALL_LOG"
}

#=============================================================================
# Disk Selection
#=============================================================================

list_disks() {
    echo ""
    echo "Available disks:"
    echo ""
    lsblk -d -o NAME,SIZE,MODEL,TYPE | grep -E "disk|NAME"
    echo ""
}

select_disk() {
    log_step "Select installation disk"
    
    list_disks
    
    while true; do
        read -rp "Enter disk (e.g., sda, nvme0n1): " disk_name
        
        [[ -z "$disk_name" ]] && { log_error "Disk name required"; continue; }
        
        TARGET_DISK="/dev/$disk_name"
        
        [[ ! -b "$TARGET_DISK" ]] && { log_error "$TARGET_DISK not found"; continue; }
        
        echo ""
        lsblk "$TARGET_DISK" -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT
        echo ""
        
        read -rp "All data on $TARGET_DISK will be DESTROYED. Continue? [y/N]: " confirm
        [[ "$confirm" =~ ^[Yy] ]] && break
    done
    
    log_success "Selected: $TARGET_DISK"
}

#=============================================================================
# System Configuration
#=============================================================================

configure_system() {
    log_step "System configuration"
    
    # Hostname
    read -rp "Hostname [$HOSTNAME]: " input
    HOSTNAME="${input:-$HOSTNAME}"
    
    # Timezone
    echo ""
    echo "Examples: UTC, America/New_York, Europe/London, Asia/Tokyo"
    read -rp "Timezone [$TIMEZONE]: " input
    if [[ -n "$input" ]]; then
        if [[ -f "/usr/share/zoneinfo/$input" ]]; then
            TIMEZONE="$input"
        else
            log_warn "Invalid timezone, using UTC"
            TIMEZONE="UTC"
        fi
    fi
    
    # Keymap
    read -rp "Keyboard layout [$KEYMAP]: " input
    KEYMAP="${input:-$KEYMAP}"
    
    echo ""
    log_substep "Hostname: $HOSTNAME"
    log_substep "Timezone: $TIMEZONE"
    log_substep "Keymap: $KEYMAP"
}

configure_user() {
    log_step "Create admin user"
    
    while true; do
        read -rp "Admin username: " ADMIN_USER
        
        [[ -z "$ADMIN_USER" ]] && { log_error "Username required"; continue; }
        [[ ! "$ADMIN_USER" =~ ^[a-z_][a-z0-9_-]*$ ]] && { log_error "Invalid username format"; continue; }
        [[ "$ADMIN_USER" == octo_* ]] && { log_error "Cannot start with 'octo_' (reserved)"; continue; }
        break
    done
    
    while true; do
        read -rsp "Password: " ADMIN_PASSWORD
        echo ""
        read -rsp "Confirm: " confirm_pass
        echo ""
        
        [[ "$ADMIN_PASSWORD" != "$confirm_pass" ]] && { log_error "Passwords don't match"; continue; }
        [[ ${#ADMIN_PASSWORD} -lt 4 ]] && { log_error "Password too short"; continue; }
        break
    done
    
    # Root password
    echo ""
    read -rp "Use same password for root? [Y/n]: " same_root
    if [[ "$same_root" =~ ^[Nn] ]]; then
        while true; do
            read -rsp "Root password: " ROOT_PASSWORD
            echo ""
            read -rsp "Confirm: " confirm_pass
            echo ""
            [[ "$ROOT_PASSWORD" == "$confirm_pass" ]] && break
            log_error "Passwords don't match"
        done
    else
        ROOT_PASSWORD="$ADMIN_PASSWORD"
    fi
    
    # SSH key
    echo ""
    read -rp "Add SSH public key? [y/N]: " add_ssh
    if [[ "$add_ssh" =~ ^[Yy] ]]; then
        echo "Paste SSH public key:"
        read -r SSH_KEY
    fi
    
    log_success "User configured: $ADMIN_USER"
}

#=============================================================================
# Installation
#=============================================================================

partition_disk() {
    log_step "Partitioning disk"
    
    # Unmount everything
    umount -R /mnt 2>/dev/null || true
    swapoff -a 2>/dev/null || true
    
    # Wipe disk
    log_substep "Wiping disk..."
    run_logged wipefs -af "$TARGET_DISK"
    run_logged sgdisk --zap-all "$TARGET_DISK" || true
    
    # Determine partition prefix
    if [[ "$TARGET_DISK" == *"nvme"* ]] || [[ "$TARGET_DISK" == *"mmcblk"* ]]; then
        PART_PREFIX="${TARGET_DISK}p"
    else
        PART_PREFIX="${TARGET_DISK}"
    fi
    
    if [[ "$BOOT_MODE" == "uefi" ]]; then
        log_substep "Creating GPT partition table (UEFI)..."
        
        run_logged parted -s "$TARGET_DISK" mklabel gpt
        run_logged parted -s "$TARGET_DISK" mkpart "EFI" fat32 1MiB 513MiB
        run_logged parted -s "$TARGET_DISK" set 1 esp on
        run_logged parted -s "$TARGET_DISK" mkpart "ROOT" ext4 513MiB 100%
        
        EFI_PART="${PART_PREFIX}1"
        ROOT_PART="${PART_PREFIX}2"
        
        log_substep "Formatting partitions..."
        run_logged mkfs.fat -F 32 -n EFI "$EFI_PART"
        run_logged mkfs.ext4 -L ROOT "$ROOT_PART"
        
        log_substep "Mounting..."
        mount "$ROOT_PART" /mnt
        mkdir -p /mnt/boot
        mount "$EFI_PART" /mnt/boot
    else
        log_substep "Creating MBR partition table (BIOS)..."
        
        run_logged parted -s "$TARGET_DISK" mklabel msdos
        run_logged parted -s "$TARGET_DISK" mkpart primary ext4 1MiB 100%
        run_logged parted -s "$TARGET_DISK" set 1 boot on
        
        ROOT_PART="${PART_PREFIX}1"
        
        log_substep "Formatting..."
        run_logged mkfs.ext4 -L ROOT "$ROOT_PART"
        
        log_substep "Mounting..."
        mount "$ROOT_PART" /mnt
    fi
    
    log_success "Disk partitioned"
}

install_base() {
    log_step "Installing base system"
    
    # Update mirrors
    log_substep "Updating mirror list..."
    if command -v reflector &>/dev/null; then
        reflector --latest 10 --sort rate --save /etc/pacman.d/mirrorlist 2>/dev/null || true
    fi
    
    # Package list - server essentials only (no GUI)
    local packages=(
        # Base
        base linux linux-firmware
        
        # Boot
        grub efibootmgr dosfstools mtools
        
        # CPU microcode
        intel-ucode amd-ucode
        
        # Networking
        networkmanager openssh
        
        # Editors
        vim neovim
        
        # Development
        git base-devel
        
        # Shell
        zsh tmux
        
        # Modern CLI
        fzf zoxide fd ripgrep bat eza jq yq htop btop tree less man-db
        
        # File management
        yazi unzip
        
        # Containers
        docker podman
        
        # Octo dependencies
        ttyd sqlite openssl
        
        # Security
        fail2ban ufw
        
        # Reverse proxy
        caddy
        
        # Fonts (for terminal)
        ttf-jetbrains-mono-nerd
    )
    
    log_substep "Installing packages (this takes a few minutes)..."
    run_with_spinner "Installing base system" pacstrap -K /mnt "${packages[@]}"
    
    log_success "Base system installed"
}

configure_system_chroot() {
    log_step "Configuring system"
    
    # fstab
    log_substep "Generating fstab..."
    genfstab -U /mnt >> /mnt/etc/fstab
    
    # Timezone
    log_substep "Setting timezone..."
    arch-chroot /mnt ln -sf "/usr/share/zoneinfo/$TIMEZONE" /etc/localtime
    arch-chroot /mnt hwclock --systohc
    
    # Locale
    log_substep "Configuring locale..."
    echo "$LOCALE UTF-8" >> /mnt/etc/locale.gen
    arch-chroot /mnt locale-gen
    echo "LANG=$LOCALE" > /mnt/etc/locale.conf
    echo "KEYMAP=$KEYMAP" > /mnt/etc/vconsole.conf
    
    # Hostname
    log_substep "Setting hostname..."
    echo "$HOSTNAME" > /mnt/etc/hostname
    cat > /mnt/etc/hosts << EOF
127.0.0.1   localhost
::1         localhost
127.0.1.1   $HOSTNAME.localdomain $HOSTNAME
EOF
    
    log_success "System configured"
}

install_bootloader() {
    log_step "Installing bootloader"
    
    if [[ "$BOOT_MODE" == "uefi" ]]; then
        log_substep "Installing GRUB (UEFI)..."
        arch-chroot /mnt grub-install --target=x86_64-efi --efi-directory=/boot --bootloader-id=GRUB
    else
        log_substep "Installing GRUB (BIOS)..."
        arch-chroot /mnt grub-install --target=i386-pc "$TARGET_DISK"
    fi
    
    log_substep "Generating GRUB config..."
    arch-chroot /mnt grub-mkconfig -o /boot/grub/grub.cfg
    
    log_success "Bootloader installed"
}

create_users() {
    log_step "Creating users"
    
    # Root password
    log_substep "Setting root password..."
    echo "root:$ROOT_PASSWORD" | arch-chroot /mnt chpasswd
    
    # Admin user
    log_substep "Creating user: $ADMIN_USER..."
    arch-chroot /mnt useradd -m -G wheel,docker -s /bin/bash "$ADMIN_USER"
    echo "$ADMIN_USER:$ADMIN_PASSWORD" | arch-chroot /mnt chpasswd
    
    # Sudo access
    echo "%wheel ALL=(ALL:ALL) ALL" > /mnt/etc/sudoers.d/wheel
    chmod 440 /mnt/etc/sudoers.d/wheel
    
    # SSH key
    if [[ -n "$SSH_KEY" ]]; then
        log_substep "Adding SSH key..."
        mkdir -p "/mnt/home/$ADMIN_USER/.ssh"
        echo "$SSH_KEY" > "/mnt/home/$ADMIN_USER/.ssh/authorized_keys"
        chmod 700 "/mnt/home/$ADMIN_USER/.ssh"
        chmod 600 "/mnt/home/$ADMIN_USER/.ssh/authorized_keys"
        arch-chroot /mnt chown -R "$ADMIN_USER:$ADMIN_USER" "/home/$ADMIN_USER/.ssh"
    fi
    
    log_success "Users created"
}

enable_services() {
    log_step "Enabling services"
    
    arch-chroot /mnt systemctl enable NetworkManager
    arch-chroot /mnt systemctl enable sshd
    arch-chroot /mnt systemctl enable docker
    
    log_success "Services enabled"
}

install_octo() {
    log_step "Installing Octo"
    
    # Copy binaries if available on ISO
    if [[ -f /usr/local/bin/octo ]]; then
        log_substep "Copying Octo binaries..."
        cp /usr/local/bin/octo /mnt/usr/local/bin/
        cp /usr/local/bin/octoctl /mnt/usr/local/bin/ 2>/dev/null || true
        cp /usr/local/bin/octo-runner /mnt/usr/local/bin/ 2>/dev/null || true
        cp /usr/local/bin/octo-files /mnt/usr/local/bin/ 2>/dev/null || true
        chmod +x /mnt/usr/local/bin/octo*
    else
        log_warn "Octo binaries not on ISO - build after first boot"
    fi
    
    # Copy setup script
    log_substep "Installing octo-setup..."
    cp /usr/local/bin/octo-setup /mnt/usr/local/bin/
    chmod +x /mnt/usr/local/bin/octo-setup
    
    # Copy systemd service
    if [[ -f /etc/systemd/system/octo.service ]]; then
        cp /etc/systemd/system/octo.service /mnt/etc/systemd/system/
    fi
    
    # Create marker for first-boot message
    mkdir -p /mnt/var/lib/octo
    cat > "/mnt/home/$ADMIN_USER/.bash_profile" << 'EOF'
# Run octo-setup on first login if not done
if [[ -f /var/lib/octo/.run-octo-setup ]]; then
    echo ""
    echo "Welcome to Octo!"
    echo ""
    echo "Run 'sudo octo-setup' to complete Octo configuration."
    echo ""
fi

# Load .bashrc
[[ -f ~/.bashrc ]] && . ~/.bashrc
EOF
    touch /mnt/var/lib/octo/.run-octo-setup
    arch-chroot /mnt chown "$ADMIN_USER:$ADMIN_USER" "/home/$ADMIN_USER/.bash_profile"
    
    log_success "Octo installed"
}

#=============================================================================
# Summary and Confirmation
#=============================================================================

show_summary() {
    log_step "Installation Summary"
    
    echo ""
    echo "  Disk:        $TARGET_DISK"
    echo "  Boot mode:   $BOOT_MODE"
    echo "  Hostname:    $HOSTNAME"
    echo "  Timezone:    $TIMEZONE"
    echo "  Admin user:  $ADMIN_USER"
    [[ -n "$SSH_KEY" ]] && echo "  SSH key:     configured"
    echo ""
    
    read -rp "Start installation? [y/N]: " confirm
    if [[ ! "$confirm" =~ ^[Yy] ]]; then
        log_info "Installation cancelled"
        exit 0
    fi
}

#=============================================================================
# Main
#=============================================================================

main() {
    show_banner
    check_requirements
    select_disk
    configure_system
    configure_user
    show_summary
    
    echo ""
    log_step "Starting installation"
    
    partition_disk
    install_base
    configure_system_chroot
    install_bootloader
    create_users
    enable_services
    install_octo
    
    # Finish
    log_step "Finishing"
    sync
    
    echo ""
    echo -e "${GREEN}${BOLD}Installation complete!${NC}"
    echo ""
    echo "After reboot:"
    echo "  1. Log in as '$ADMIN_USER'"
    echo "  2. Run: sudo octo-setup"
    echo ""
    echo "Installation log: $INSTALL_LOG"
    echo ""
    
    read -rp "Press Enter to reboot..."
    
    umount -R /mnt
    reboot
}

main "$@"
